name: Generate SEO Metadata

on:
  push:
    branches:
      - main
    paths:
      - 'events.json'
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate-seo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Verify events.json exists
        run: |
          if [ ! -f "events.json" ]; then
            echo "âŒ events.json not found"
            exit 1
          fi
          echo "âœ… events.json found"

      - name: Create scripts directory
        run: mkdir -p scripts

      - name: Create SEO generator script (CommonJS)
        run: |
          cat > scripts/generate-seo.cjs << 'EOF'
          const fs = require('fs');
          const path = require('path');

          const EVENTS_FILE = path.join(__dirname, '..', 'events.json');
          const OUTPUT_FILE = 'seo-metadata.json';
          const DOMAIN = 'https://tarjetarojaenvivo.live';

          const PRIMARY_KEYWORDS = [
            'rojadirecta','tarjeta roja','rojadirecta tv','pirlotv',
            'tarjeta roja tv','rojadirecta en vivo','tarjeta roja directa',
            'tarjeta roja en vivo','pirlo tv rojadirecta','roja directa pirlo',
            'tarjeta roja futbol en vivo','roja directa en vivo fÃºtbol gratis',
            'tarjeta roja fÃºtbol en vivo','pirlo tv tarjeta roja',
            'tarjeta roja tv en vivo','roja tv','la roja directa',
            'rojadirecta tv en vivo','roja dirÃ©cta'
          ];

          const slug = t => t.toLowerCase().normalize('NFD')
            .replace(/[\u0300-\u036f]/g,'')
            .replace(/[^a-z0-9]+/g,'-')
            .replace(/^-+|-+$/g,'');

          const translate = c => ({
            'Football':'FÃºtbol','Basketball':'Baloncesto',
            'American Football':'FÃºtbol Americano',
            'Ice Hockey':'Hockey sobre Hielo',
            'Combat Sports':'Deportes de Combate',
            'Wrestling':'Lucha Libre','Darts':'Dardos'
          })[c] || c;

          const d = ts => new Date(ts * 1000);
          const months = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
          const days = ['domingo','lunes','martes','miÃ©rcoles','jueves','viernes','sÃ¡bado'];

          const fmt = ts => {
            const x = d(ts);
            return {
              iso: x.toISOString(),
              full: `${days[x.getDay()]} ${x.getDate()} de ${months[x.getMonth()]} de ${x.getFullYear()}`,
              time: `${String(x.getHours()).padStart(2,'0')}:${String(x.getMinutes()).padStart(2,'0')}`
            };
          };

          const data = JSON.parse(fs.readFileSync(EVENTS_FILE,'utf8'));

          const out = { generated_at:new Date().toISOString(), total_events:0, categories:[], events:[] };

          for (const cat of data.events.streams) {
            const catEs = translate(cat.category);
            out.categories.push({
              name: cat.category,
              name_es: catEs,
              slug: slug(catEs),
              canonical_url: `${DOMAIN}/categoria/${slug(catEs)}`
            });

            for (const s of cat.streams) {
              const start = fmt(s.starts_at);
              const end = fmt(s.ends_at);
              out.events.push({
                id: s.id,
                slug: slug(s.name),
                canonical_url: `${DOMAIN}/eventos/${s.uri_name}`,
                meta: {
                  title: `${s.name} EN VIVO - Tarjeta Roja TV`,
                  description: `Ver ${s.name} en vivo gratis el ${start.full}`,
                  keywords: [...PRIMARY_KEYWORDS, s.name, catEs].join(', ')
                },
                event: {
                  start_time: start.iso,
                  end_time: end.iso,
                  status: s.starts_at < Date.now()/1000 ? 'en vivo' : 'prÃ³ximamente'
                },
                technical: {
                  last_modified: new Date().toISOString(),
                  changefreq: 'hourly',
                  priority: 0.85
                }
              });
              out.total_events++;
            }
          }

          fs.writeFileSync(OUTPUT_FILE, JSON.stringify(out,null,2));
          console.log(`âœ… SEO generated: ${out.total_events} events`);

          const sitemap = [
            { loc: DOMAIN, lastmod:new Date().toISOString(), changefreq:'always', priority:1.0 },
            ...out.events.map(e => ({
              loc:e.canonical_url,
              lastmod:e.technical.last_modified,
              changefreq:e.technical.changefreq,
              priority:e.technical.priority
            }))
          ];

          fs.writeFileSync('sitemap-urls.json', JSON.stringify(sitemap,null,2));
          fs.writeFileSync('keywords.json', JSON.stringify({PRIMARY_KEYWORDS},null,2));
          EOF

      - name: Run SEO generator
        run: node scripts/generate-seo.cjs

      - name: Generate XML Sitemap (CommonJS)
        run: |
          cat > generate-sitemap.cjs << 'EOF'
          const fs = require('fs');
          const urls = JSON.parse(fs.readFileSync('sitemap-urls.json','utf8'));
          let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n';
          urls.forEach(u=>{
            xml += `<url><loc>${u.loc}</loc><lastmod>${u.lastmod}</lastmod><changefreq>${u.changefreq}</changefreq><priority>${u.priority}</priority></url>\n`;
          });
          xml += '</urlset>';
          fs.writeFileSync('sitemap.xml', xml);
          console.log('âœ… sitemap.xml generated');
          EOF
          node generate-sitemap.cjs

      - name: Generate robots.txt
        run: |
          cat > robots.txt << 'EOF'
          User-agent: *
          Allow: /
          Sitemap: https://tarjetarojaenvivo.live/sitemap.xml
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          mkdir -p public
          cp sitemap.xml robots.txt public/
          git add seo-metadata.json sitemap-urls.json keywords.json public/sitemap.xml public/robots.txt || true
          git diff --staged --quiet || git commit -m "ðŸ¤– Auto-generate SEO & sitemap" && git push
